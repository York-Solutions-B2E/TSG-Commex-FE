@inherits LayoutComponentBase
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Primary" Fixed="true">
        <MudText Typo="Typo.h5" Class="ml-3">Commex Lifecycle</MudText>
        <MudSpacer />
        <AuthorizeView>
            <Authorized>
                <MudButton Color="Color.Inherit" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Logout"
                    OnClick="Logout">
                    Logout
                </MudButton>
            </Authorized>
            <NotAuthorized>
                <MudButton Color="Color.Inherit" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Login"
                    OnClick="Login">
                    Login
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    <MudMainContent>
        <MudPaper Elevation="2" Square="true"
            Style="position: sticky; top: 64px; z-index: 100; background-color: white;">
            <AuthorizeView>
                <Authorized>
                    <MudTabs Elevation="0" Rounded="false" Centered="false" ApplyEffectsToContainer="false"
                        ActivePanelIndex="activeTab" ActivePanelIndexChanged="OnTabChanged">
                        @if (context.User.IsInRole("Admin"))
                        {
                            <MudTabPanel Text="Event Simulator" Icon="@Icons.Material.Filled.Science" />
                            <MudTabPanel Text="Admin" Icon="@Icons.Material.Filled.AdminPanelSettings" />
                            <MudTabPanel Text="Debug" Icon="@Icons.Material.Filled.BugReport" />
                        }
                        else
                        {
                            <MudTabPanel Text="Communications" Icon="@Icons.Material.Filled.Email" />
                        }
                    </MudTabs>
                </Authorized>
                <NotAuthorized>
                    <MudTabs Elevation="0" Rounded="false" Centered="false" ApplyEffectsToContainer="false"
                        ActivePanelIndex="0">
                        <MudTabPanel Text="Please Login" Icon="@Icons.Material.Filled.Lock" />
                    </MudTabs>
                </NotAuthorized>
            </AuthorizeView>
        </MudPaper>

        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private int activeTab = 0;
    private bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is admin
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        isAdmin = authState.User.IsInRole("Admin");
        
        // Set active tab based on current URL
        SetActiveTabFromUrl();
        Navigation.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        SetActiveTabFromUrl();
        StateHasChanged();
    }

    private void SetActiveTabFromUrl()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var path = uri.LocalPath.ToLower();

        if (isAdmin)
        {
            // Admin users have: Event Simulator, Admin, Debug
            if (path.Contains("event-simulator"))
                activeTab = 0;
            else if (path.Contains("admin"))
                activeTab = 1;
            else if (path.Contains("debug"))
                activeTab = 2;
            else
                activeTab = 1; // Default to Admin tab for admin users
        }
        else
        {
            // Non-admin users only have Communications tab
            activeTab = 0; // Always Communications
        }
    }

    private void OnTabChanged(int index)
    {
        activeTab = index;
        string url;
        
        if (isAdmin)
        {
            // Admin users have: Event Simulator, Admin, Debug
            url = index switch
            {
                0 => "/event-simulator",
                1 => "/admin",  // Always go to main admin page, not subpages
                2 => "/debug",
                _ => "/admin"
            };
        }
        else
        {
            // Non-admin users only have Communications
            url = "/communications";
        }
        
        // Force navigation even if already on an admin subpage
        Navigation.NavigateTo(url, forceLoad: false);
    }

    private void Login()
    {
        Navigation.NavigateTo("/Auth/SignIn", true);
    }

    private void Logout()
    {
        Navigation.NavigateTo("/Auth/SignOut", true);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
