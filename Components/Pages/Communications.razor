@page "/communications"
@rendermode InteractiveServer
@inject IHttpClientFactory HttpClientFactory
@inject ILogger<Communications> Logger
@inject NavigationManager Navigation
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

<PageTitle>Communications</PageTitle>

<AuthorizeView>
    <Authorized>
        <h3>Communications Management</h3>
        @if (communications == null)
        {
            <MudProgressCircular Indeterminate="true" />
            <MudText Class="ml-2">Loading communications...</MudText>
        }
        else if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">
                Error: @errorMessage
                <MudButton OnClick="@LoadCommunications" Variant="Variant.Text" Size="Size.Small" Class="ml-2">
                    Retry
                </MudButton>
            </MudAlert>
        }
        else
        {
            <MudGrid>
                <MudItem xs="12" md="@(selectedCommunication == null ? 12 : 6)">
                    <MudTable Items="@communications" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="2" Class="mt-4"
                        @bind-SelectedItem="selectedCommunication" T="CommunicationResponse">
                <ColGroup>
                    <col style="width:80px;" />
                    <col />
                    <col style="width:120px;" />
                    <col style="width:100px;" />
                    <col style="width:140px;" />
                    <col style="width:140px;" />
                    <col style="width:120px;" />
                </ColGroup>
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Subject</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Recipient</MudTh>
                    <MudTh>Created</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate Context="communication">
                    <MudTd DataLabel="ID" Class="pa-3">@communication.Id</MudTd>
                    <MudTd DataLabel="Subject" Class="pa-3">
                        <MudText Typo="Typo.body2" Class="mb-1">@communication.Subject</MudText>
                        @if (!string.IsNullOrEmpty(communication.Message))
                        {
                            <MudText Typo="Typo.caption" Class="text-truncate" Style="max-width: 250px;">
                                @communication.Message
                            </MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Type" Class="pa-3">
                        <MudChip T="string" Size="Size.Small" Color="@GetTypeColor(communication.TypeCode)">
                            @communication.TypeCode
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Status" Class="pa-3">
                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(communication.CurrentStatus)">
                            @communication.CurrentStatus
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Recipient" Class="pa-3">@communication.RecipientInfo</MudTd>
                    <MudTd DataLabel="Created" Class="pa-3">
                        <MudText Typo="Typo.body2" Class="mb-1">@communication.CreatedUtc.ToString("MM/dd/yyyy")</MudText>
                        <MudText Typo="Typo.caption">by @communication.CreatedByUserName</MudText>
                    </MudTd>
                    <MudTd DataLabel="" Class="pa-3">
                        <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary"
                            OnClick="@(() => ViewDetails(communication.Id))">
                            Details
                        </MudButton>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                </PagerContent>
                    </MudTable>
                </MudItem>
                
                @if (selectedCommunication != null)
                {
                    <MudItem xs="12" md="6">
                        <TSG_Commex_FE.Components.Shared.CommunicationDetailView 
                            Communication="selectedCommunication"
                            ShowAdminDetails="false"
                            UseTimelineView="true"
                            ShowViewDetailsButton="true"
                            AutoLoadHistory="true"
                            OnClose="@(() => selectedCommunication = null)" />
                    </MudItem>
                }
            </MudGrid>
        }
    </Authorized>
    <NotAuthorized>
        <MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
            <MudPaper Elevation="2" Class="pa-8 text-center">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Primary" Class="mb-4" />
                <MudText Typo="Typo.h4" Class="mb-2">Sign In Required</MudText>
                <MudText Typo="Typo.body1" Class="mb-6">You need to sign in to view your communications.</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" 
                    Href="/Auth/SignIn?returnUrl=/communications" FullWidth="true">
                    Sign In
                </MudButton>
            </MudPaper>
        </MudContainer>
    </NotAuthorized>
</AuthorizeView>

@code {
    private IEnumerable<CommunicationResponse>? communications;
    private CommunicationResponse? selectedCommunication;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCommunications();
    }

    private async Task LoadCommunications()
    {
        try
        {
            errorMessage = null;
            communications = null;
            StateHasChanged();

            var httpClient = HttpClientFactory.CreateClient("API");
            communications = await httpClient.GetFromJsonAsync<IEnumerable<CommunicationResponse>>("api/communications");

            Logger.LogInformation("✅ Successfully loaded {Count} communications", communications?.Count() ?? 0);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Logger.LogError(ex, "❌ Error loading communications from API");
        }
        finally
        {
            StateHasChanged();
        }
    }



    private void ViewDetails(int communicationId)
    {
        Navigation.NavigateTo($"/communications/{communicationId}");
    }

    private Color GetStatusColor(string status)
    {
        return status.ToLower() switch
        {
            "created" or "readyforrelease" => Color.Info,
            "released" or "queuedforprinting" => Color.Warning,
            "printed" or "inserted" or "warehouseready" => Color.Primary,
            "shipped" or "intransit" => Color.Secondary,
            "delivered" => Color.Success,
            "returned" or "failed" or "cancelled" or "expired" => Color.Error,
            "archived" => Color.Dark,
            _ => Color.Default
        };
    }

    private Color GetTypeColor(string typeCode)
    {
        return typeCode switch
        {
            "EOB" => Color.Primary,
            "EOP" => Color.Secondary,
            "ID_CARD" => Color.Tertiary,
            _ => Color.Default
        };
    }

}