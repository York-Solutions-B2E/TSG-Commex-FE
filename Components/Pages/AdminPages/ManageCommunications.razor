@page "/admin/manage-communications"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using TSG_Commex_Shared.DTOs
@using TSG_Commex_Shared.DTOs.Response
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Manage Communications</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-3">
    <MudText Typo="Typo.h4" Class="mb-4">Manage Communications</MudText>
    
    <!-- Add Communication Section -->
    <MudPaper Class="pa-4 mb-3" Elevation="1">
        <MudText Typo="Typo.h6" Class="mb-3">Create New Communication</MudText>
        
        <MudForm @ref="form" @bind-IsValid="@isFormValid">
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="int?" Label="Communication Type" @bind-Value="newCommunication.CommunicationTypeId" Required="true" 
                               RequiredError="Communication type is required">
                        @if (communicationTypes != null)
                        {
                            @foreach (var type in communicationTypes)
                            {
                                <MudSelectItem Value="@((int?)type.Id)">@type.DisplayName (@type.TypeCode)</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField @bind-Value="newCommunication.Title" Label="Title" Required="true"
                                  RequiredError="Title is required" />
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="int?" Label="Member" @bind-Value="newCommunication.MemberId" Required="true"
                               RequiredError="Member is required">
                        @if (members != null)
                        {
                            @foreach (var member in members)
                            {
                                <MudSelectItem Value="@((int?)member.Id)">@member.FullName (@member.MemberId)</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>
                
                <MudItem xs="12" sm="6" md="3">
                    <MudTextField @bind-Value="newCommunication.SourceFileUrl" Label="Source File URL" 
                                  HelperText="URL to the source document" />
                </MudItem>
                
                <MudItem xs="12">
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateCommunication" 
                               Disabled="@(!isFormValid || isCreating)" StartIcon="@Icons.Material.Filled.Add">
                        @if (isCreating)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="ms-2" />
                            <span class="ms-2">Creating...</span>
                        }
                        else
                        {
                            <span>Create Communication</span>
                        }
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>
    </MudPaper>
    
    <!-- Communications List -->
    <MudGrid Spacing="3">
        <MudItem xs="12" lg="@(selectedCommunication == null ? 12 : 8)">
            <MudPaper Class="pa-4" Elevation="1" Style="height: calc(100vh - 350px); overflow-y: auto;">
                <MudText Typo="Typo.h6" Class="mb-3">Existing Communications</MudText>
                
                @if (isLoading)
                {
                    <MudProgressLinear Indeterminate="true" />
                }
                else if (communications == null || !communications.Any())
                {
                    <MudAlert Severity="Severity.Info">No communications found. Create one above!</MudAlert>
                }
                else
                {
                    <MudTable Items="@communications" Hover="true" Striped="true" Dense="true"
                              SelectedItem="selectedCommunication" SelectedItemChanged="OnCommunicationSelected" T="CommunicationResponse">
                        <HeaderContent>
                            <MudTh>ID</MudTh>
                            <MudTh>Subject</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Member</MudTh>
                            <MudTh>Created</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="ID">@context.Id</MudTd>
                            <MudTd DataLabel="Subject">@context.Subject</MudTd>
                            <MudTd DataLabel="Type">
                                <MudChip T="string" Size="Size.Small" Color="GetTypeColor(context.TypeCode)">
                                    @context.TypeCode
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Size="Size.Small" Color="GetStatusColor(context.CurrentStatus)">
                                    @context.CurrentStatus
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Member">
                                <MudText Typo="Typo.body2">@context.MemberName</MudText>
                                <MudText Typo="Typo.caption">@context.RecipientInfo</MudText>
                            </MudTd>
                            <MudTd DataLabel="Created">@context.CreatedUtc.ToLocalTime().ToString("g")</MudTd>
                            <MudTd DataLabel="Actions">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" 
                                               Size="Size.Small" OnClick="@(async (e) => { await DeleteCommunication(context.Id); })" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudPaper>
        </MudItem>
        
        @if (selectedCommunication != null)
        {
            <MudItem xs="12" lg="4">
                <div style="height: calc(100vh - 350px); overflow-y: auto;">
                    <TSG_Commex_FE.Components.Shared.CommunicationDetailView 
                        Communication="selectedCommunication"
                        ShowAdminDetails="true"
                        UseTimelineView="false"
                        ShowViewDetailsButton="true"
                        AutoLoadHistory="true"
                        OnClose="@(() => { selectedCommunication = null; StateHasChanged(); })" />
                </div>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    private MudForm form;
    private bool isFormValid;
    private bool isCreating = false;
    private bool isLoading = true;
    private List<CommunicationResponse> communications = new();
    private List<MemberDto> members = new();
    private List<CommunicationTypeResponse> communicationTypes = new();
    private CommunicationResponse? selectedCommunication;
    
    [Inject] private IHttpClientFactory HttpClientFactory { get; set; }
    [Inject] private ISnackbar Snackbar { get; set; }
    
    private CreateCommunicationModel newCommunication = new();
    
    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadCommunications(), LoadMembers(), LoadCommunicationTypes());
    }
    
    private void OnCommunicationSelected(CommunicationResponse communication)
    {
        selectedCommunication = communication;
        StateHasChanged();
    }
    
    private async Task LoadCommunications()
    {
        try
        {
            isLoading = true;
            var httpClient = HttpClientFactory.CreateClient("API");
            communications = await httpClient.GetFromJsonAsync<List<CommunicationResponse>>("api/communications") ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading communications: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task LoadMembers()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("API");
            members = await httpClient.GetFromJsonAsync<List<MemberDto>>("api/members/active") ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading members: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task LoadCommunicationTypes()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("API");
            communicationTypes = await httpClient.GetFromJsonAsync<List<CommunicationTypeResponse>>("api/communication-types") ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading communication types: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task CreateCommunication()
    {
        try
        {
            isCreating = true;
            var httpClient = HttpClientFactory.CreateClient("API");
            var response = await httpClient.PostAsJsonAsync("api/communications", newCommunication);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Communication created successfully!", Severity.Success);
                newCommunication = new CreateCommunicationModel(); // Reset form
                await LoadCommunications(); // Refresh list
            }
            else
            {
                Snackbar.Add("Failed to create communication", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isCreating = false;
        }
    }
    
    private async Task DeleteCommunication(int id)
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("API");
            var response = await httpClient.DeleteAsync($"api/communications/{id}");
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Communication deleted successfully!", Severity.Success);
                await LoadCommunications();
            }
            else
            {
                Snackbar.Add("Failed to delete communication", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
    
    private Color GetTypeColor(string typeCode)
    {
        return typeCode switch
        {
            "EOB" => Color.Primary,
            "EOP" => Color.Secondary,
            "ID_CARD" => Color.Tertiary,
            _ => Color.Default
        };
    }
    
    private Color GetStatusColor(string status)
    {
        return status.ToLower() switch
        {
            "created" or "readyforrelease" => Color.Info,
            "released" or "queuedforprinting" => Color.Warning,
            "printed" or "inserted" or "warehouseready" => Color.Primary,
            "shipped" or "intransit" => Color.Secondary,
            "delivered" => Color.Success,
            "returned" or "failed" or "cancelled" or "expired" => Color.Error,
            "archived" => Color.Dark,
            _ => Color.Default
        };
    }
    
    public class CreateCommunicationModel
    {
        public int? CommunicationTypeId { get; set; }
        public string Title { get; set; } = string.Empty;
        public int? MemberId { get; set; }
        public string? SourceFileUrl { get; set; }
    }
}